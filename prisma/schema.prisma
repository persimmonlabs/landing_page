// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT SAAS SCHEMA
// ============================================
// NOTE: Users are managed by Supabase Auth (auth.users table)
// We reference them via UUID but don't create a separate users table

// Company/Organization table
model Company {
  id        String      @id @default(uuid())
  name      String
  slug      String      @unique // URL-friendly identifier
  industry  String?
  website   String?
  logoUrl   String?     @map("logo_url")
  settings  Json?       // Company-specific settings
  plan      CompanyPlan @default(FREE)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  members   CompanyMember[]
  brandKits BrandKit[]

  @@index([slug])
  @@map("companies")
}

// Company membership (junction table for User <-> Company)
model CompanyMember {
  id        String            @id @default(uuid())
  userId    String            @map("user_id") // References auth.users(id)
  companyId String            @map("company_id")
  role      CompanyMemberRole @default(MEMBER)
  invitedBy String?           @map("invited_by") // User ID who invited
  joinedAt  DateTime          @default(now()) @map("joined_at")
  createdAt DateTime          @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("company_members")
}

// Brand Kit (migrated from brandkit_generator)
model BrandKit {
  id                  String    @id @default(uuid())
  companyId           String    @map("company_id") // Changed from user_id
  createdBy           String    @map("created_by") // References auth.users(id)
  businessName        String    @map("business_name")
  businessDescription String?   @map("business_description") @db.Text
  industry            String?
  logoUrl             String    @map("logo_url") @db.Text
  logoSvg             String?   @map("logo_svg") @db.Text
  colors              Json // Array of {name, hex, usage}
  fonts               Json // {primary, secondary}
  tagline             String?   @db.Text
  isFavorite          Boolean   @default(false) @map("is_favorite")
  viewCount           Int       @default(0) @map("view_count")
  lastViewedAt        DateTime? @map("last_viewed_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shareTokens ShareToken[]

  @@index([companyId])
  @@index([createdBy])
  @@index([companyId, createdAt])
  @@index([companyId, isFavorite])
  @@map("brand_kits")
}

// Share tokens for public brand kit access
model ShareToken {
  id          String    @id @default(uuid())
  brandKitId  String    @map("brand_kit_id")
  token       String    @unique @db.VarChar(64)
  expiresAt   DateTime? @map("expires_at")
  viewCount   Int       @default(0) @map("view_count")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  brandKit BrandKit @relation(fields: [brandKitId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([brandKitId])
  @@index([expiresAt])
  @@map("share_tokens")
}

// ============================================
// DEMO GENERATOR (EXISTING)
// ============================================

model Demo {
  id          String       @id @default(uuid())
  email       String
  brandName   String       @map("brand_name")
  industry    String
  tone        String
  platforms   String[]
  website     String?
  publicToken String       @unique @map("public_token")
  status      DemoStatus   @default(PROCESSING)
  metadata    Json?
  createdAt   DateTime     @default(now()) @map("created_at")
  completedAt DateTime?    @map("completed_at")

  results  DemoResult[]
  webhooks WebhookLog[]

  @@index([email])
  @@index([publicToken])
  @@map("demos")
}

model DemoResult {
  id           String   @id @default(uuid())
  demoId       String   @map("demo_id")
  platform     String
  variantIndex Int      @default(0) @map("variant_index")
  caption      String   @db.Text
  hashtags     String[]
  cta          String?
  previewUrl   String?  @map("preview_url")
  metrics      Json?
  createdAt    DateTime @default(now()) @map("created_at")

  demo Demo @relation(fields: [demoId], references: [id], onDelete: Cascade)

  @@index([demoId])
  @@map("demo_results")
}

model WebhookLog {
  id          String        @id @default(uuid())
  demoId      String        @map("demo_id")
  webhookType WebhookType   @map("webhook_type")
  status      WebhookStatus @default(PENDING)
  url         String?
  payload     Json
  response    Json?
  attempts    Int           @default(0)
  lastAttempt DateTime?     @map("last_attempt")
  createdAt   DateTime      @default(now()) @map("created_at")
  completedAt DateTime?     @map("completed_at")

  demo Demo @relation(fields: [demoId], references: [id], onDelete: Cascade)

  @@index([demoId])
  @@index([status])
  @@map("webhook_logs")
}

model EmailQueue {
  id          String      @id @default(uuid())
  to          String
  subject     String
  template    String
  data        Json
  status      EmailStatus @default(PENDING)
  attempts    Int         @default(0)
  lastAttempt DateTime?   @map("last_attempt")
  sentAt      DateTime?   @map("sent_at")
  error       String?
  createdAt   DateTime    @default(now()) @map("created_at")

  @@index([status])
  @@index([to])
  @@map("email_queue")
}

// ============================================
// ENUMS
// ============================================

enum CompanyPlan {
  FREE
  STARTER
  GROWTH
  ENTERPRISE
}

enum CompanyMemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum DemoStatus {
  PROCESSING
  COMPLETED
  FAILED
}

enum WebhookType {
  N8N
  ZAPIER
  CUSTOM
}

enum WebhookStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}